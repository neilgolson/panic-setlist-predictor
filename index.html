<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Panic Setlist Predictor</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#0a0a0a;--bg2:#141414;--bg3:#1e1e1e;
      --red:#ff3366;--orange:#ff8c42;--yellow:#ffd93d;--green:#4ade80;--purple:#a855f7;
      --t1:#f0f0f0;--t2:#999;--t3:#555;--bdr:#2a2a2a;
      --avail:#4ade80;--rest:#fbbf24;--played:#f87171;
      --safe-b:env(safe-area-inset-bottom,0px);--tab-h:60px;--sidebar-w:0px
    }
    html{font-size:106.25%}
    html,body{height:100%;overflow:hidden;font-family:'Crimson Pro',Georgia,serif;background:var(--bg);color:var(--t1)}
    #root{height:100%}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:900;opacity:0;pointer-events:none;transition:opacity .3s}.sheet-bg.on{opacity:1;pointer-events:auto}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:var(--bg2);border-radius:20px 20px 0 0;z-index:950;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1);max-height:92vh;display:flex;flex-direction:column;box-shadow:0 -8px 40px rgba(0,0,0,.5)}.sheet.on{transform:translateY(0)}
    @media(min-width:768px){
      .sheet{left:50%;right:auto;bottom:auto;top:50%;width:560px;max-width:90vw;max-height:80vh;border-radius:16px;transform:translate(-50%,-50%) scale(.95);opacity:0;transition:transform .25s ease,opacity .25s ease;box-shadow:0 24px 80px rgba(0,0,0,.6)}
      .sheet.on{transform:translate(-50%,-50%) scale(1);opacity:1}
      .sheet-bar{display:none}
      .sheet-bd{padding-bottom:1.5rem}
    }
    .sheet-bar{width:36px;height:5px;border-radius:3px;background:#444;margin:10px auto 6px;flex-shrink:0}
    .sheet-hd{padding:0 1.25rem .75rem;border-bottom:1px solid var(--bdr);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
    .sheet-hd h3{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:.06em}
    .sheet-bd{overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1;padding:1rem 1.25rem;padding-bottom:calc(1rem + var(--safe-b))}
    .sheet-x{background:none;border:none;color:var(--t2);font-size:1.6rem;cursor:pointer;padding:.25rem;line-height:1}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
    @media(min-width:768px){
      html{font-size:93.75%}
      :root{--sidebar-w:200px;--tab-h:0px;--safe-b:0px}
      .app-shell{flex-direction:row!important}
      .app-content{max-width:calc(100vw - var(--sidebar-w) - 1rem)!important;padding-left:1.5rem!important;padding-right:1rem!important;margin-left:var(--sidebar-w)!important;margin-right:0!important;box-sizing:border-box!important}
      .bottom-nav{display:none!important}
      .side-nav{display:flex!important}
      .pred-grid{display:block}
    }
    @media(min-width:1280px){
      .app-content{max-width:820px;padding-left:2.5rem!important;padding-right:2.5rem!important}
      .pred-grid{display:grid!important;grid-template-columns:1fr 1fr;gap:.5rem}
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const{useState,useEffect,useMemo,useCallback,useRef}=React;

    /* â”€â”€â”€ DATA â”€â”€â”€ */
    const FAVORITES=["Up All Night","Climb To Safety","Ain't Life Grand","Space Wrangler","Airplane","Driving Song","Pleas","Bear's Gone Fishin'","Chilly Water","Tall Boy","Blue Indian","Disco","Party At Your Mama's House","Little Lilly","Nobody's Loss","Porch Song","Little by Little","The Last Straw","Love Tractor","Hatfield","Papa's Home","Wondering","Blackout Blues","Aunt Avis","Hope In A Hopeless World","C. Brown","Pilgrims","And It Stoned Me","Holden Oversoul","Stop-Go","All Time Low","Travelin' Light","Can't Get High","One Arm Steve","Surprise Valley","Walkin' (For Your Love)","Diner","Jack","Dyin' Man","The Waker","Pickin' Up The Pieces"];
    const DEFAULT_THEME_SONGS={valentine:['Love Tractor','Climb To Safety','Walkin\' (For Your Love)','Mercy','Barstools And Dreamers','Who Do You Belong To','Airplane','Tie Your Shoes','Red Hot Mama','Ride Me High','Genesis','Gradle','Diner','Blight','Space Wrangler','Papa\'s Home','Gimme'],july4th:['Disco','Ain\'t Life Grand','Tall Boy','C. Brown','Party At Your Mama\'s House','North'],newyear:['Disco','Ain\'t Life Grand','Tall Boy','C. Brown','Party At Your Mama\'s House'],cityReferences:['Makes Sense To Me:Atlanta','Up All Night:Savannah','Hatfield:San Diego','Hatfield:Los Angeles','Fishwater:New Orleans','Bayou Lena:New Orleans','Hope In A Hopeless World:New York City','Action Man:Saratoga','Bust It Big:New York City'],stateReferences:['Don\'t Tell The Band:GA','Henry Parsons Died:GA','Up All Night:GA','Hatfield:CA','Rebirtha:KS','Visiting Day:TN'],sequentialPairs:['Machine<->Barstools And Dreamers','Protein Drink<->Sewing Machine','Goodpeople<->Dark Bar','Travelin\' Man<->The Waker','Jack<->Bear\'s Gone Fishin\'','Bear\'s Gone Fishin\'<->Tie Your Shoes','Party At Your Mama\'s House<->Stop Breakin\' Down Blues','Surprise Valley<->Blackout Blues']};
    const BEACH_CITIES=['miami','fort lauderdale','west palm beach','jacksonville','st. augustine','savannah','charleston','myrtle beach','wilmington','outer banks','virginia beach','norfolk','ocean city','rehoboth','atlantic city','asbury park','long beach','brooklyn','queens','boston','portland','providence','newport','cape cod','tampa','st. petersburg','clearwater','sarasota','naples','fort myers','pensacola','panama city','destin','mobile','gulfport','biloxi','new orleans','galveston','corpus christi','south padre','san diego','los angeles','santa monica','malibu','santa barbara','san luis obispo','monterey','santa cruz','san francisco','oakland','berkeley','sausalito','portland','seattle','tacoma','honolulu','maui','kauai','anchorage','juneau'];
    const ALL_SONGS=["Chilly Water","Travelin' Light","Space Wrangler","Coconut","Porch Song","Stop-Go","Driving Song","Holden Oversoul","Contentment Blues","Me And The Devil Blues","Heaven","Send Your Mind","Walkin' (For Your Love)","Pigeons","Mercy","Rock","Makes Sense To Me","C. Brown","Love Tractor","Weight Of The World","I'm Not Alone","Barstools And Dreamers","Proving Ground","The Last Straw","Pleas","Hatfield","Wondering","Papa's Home","Diner","Better Off","Pickin' Up The Pieces","Henry Parsons Died","Pilgrims","Postcard","Dream Song","Little Kin","Ain't Life Grand","Airplane","Can't Get High","Heroes","Junior","Blackout Blues","Jack","Fishwater","Radio Child","Aunt Avis","Tall Boy","Gradle","Rebirtha","You Got Yours","Greta","Surprise Valley","Bear's Gone Fishin'","Climb To Safety","Blue Indian","The Waker","Dyin' Man","One Arm Steve","Christmas Katie","All Time Low","Nobody's Loss","Fishing","Tortured Artist","Papa Johnny Road","Sparks Fly","Don't Wanna Lose You","Monstrosity","Travelin' Man","Second Skin","Goodpeople","From The Cradle","Ribs And Whiskey","Crazy","You Should Be Glad","May Your Glass Be Filled","Walk On The Flood","Free Somehow","Flicker","Her Dance Needs No Body","Up All Night","Saint Ex","North","Dirty Side Down","Visiting Day","Shut Up And Drive","Cotton Was King","Cosmic Confidante","Tickle the Truth","Time Zones","Sundown Betty","Elevator To The Moon","Entering A Black Hole Backwards","Last Dance","Quarter Tank Of Gasoline","Puppy Sleeps","When You Coming Home","Jaded Tourist","Hope In A Hopeless World"].sort();
    const COMMON_COVERS=["Low Spark Of High Heeled Boys","Bowlegged Woman","Let's Get Down To Business","Sleeping Man","Conrad","Machine","Dark Bar","Party At Your Mama's House","Stop Breakin' Down Blues","Mr. Soul","Little By Little","Walk On","Pleas","There Is A Time","Let's Get The Show On The Road","Sewing Machine","Protein Drink","Bust It Big","We Walk Each Other Home","Don't Be Denied","Down in a Hole","Who Do You Belong To?","Big Wooly Mammoth","King Baby","Sitting In Limbo","I Can See Clearly Now","Paranoid","War Pigs","Disco","Tie Your Shoes","Ride Me High","Little Lilly","Trashy","Down","Drums","Jam","Arleen","Smokestack Lightning","Blight","Pusherman","For What It's Worth","Action Man","Good Morning Little Schoolgirl","Chainsaw City","I Walk On Guilded Splinters","I'm So Glad","And It Stoned Me","Red Hot Mama","Spoonful","Maggot Brain","Jack Straw","Blue Carousel","The Take Out","1 x 1","A Hard Rain's A-Gonna Fall","A of D","B of D","Bird On A Wire","Black Hole Sun","Black Sabbath","Breathing Slow","Can't Find My Way Home","Cease Fire","City of Dreams","Clair de Lune","Comfortably Numb","Cortez the Killer","Cream Puff War","Dead Flowers","Dear Mr. Fantasy","Dear Prudence","Degenerate","Dirty Business","End Of The Show","Expiration Day","Fairies Wear Boots","Fixin' To Die","Flat Foot Flewzy","Four Cornered Room","Genesis","Gimme","Give","Godzilla","Goin' Out West","Halloween Face","Happy","Help Me Somebody","Honey Bee","Honky Red","Imitation Leather Shoes","Impossible","Iron Man","Jamais Vu","Jessica","Keep Me in Your Heart","Knocking 'Round The Zoo","Lawyers, Guns, And Money","Life As A Tree","Life During Wartime","Little Wing","Narrow Mind","No Sugar Tonight/New Mother Nature","None of Us Are Free","Old Joe","Old Neighborhood","One Kind Favor","Piece of My Heart","Play a Train Song","Red Beans","Riders On The Storm","Room at the Top","Rumble","Sharon","Sleepy Monkey","Slippin' Into Darkness","Small Town","Sometimes","Soul Kitchen","Steven's Cat","Stranger in a Strange Land","Tackle Box Hero","Tail Dragger","The Harder They Come","This Part Of Town","Thought Sausage","Time Is Free","Vacation","Waitin' For The Bus","We're All Mad Here","Weak Brain","White Rabbit","Who Are You","Worry","You Can't Always Get What You Want","You Wreck Me","You're Lost Little Girl","Ace of Spades","Are You Ready For The Country?","Casa Del Grillo","Come Together","Crazy Train","Don't Drink The Water","Heart of Gold","I Got The Same Old Blues","I Wanna Be Sedated","I'll Sleep When I'm Dead","Jesus Just Left Chicago","Let It Rock","Machine Gun","Mr. Crowley","My Generation","Nobody's Fault But Mine","Ophelia","Over The Rainbow","Papa Legba","Roadhouse Blues","Rockin' In The Free World","Running Down A Dream","Snowblind","Straight To Hell","The Golden Road (To Unlimited Devotion)","The Wizard","Thin Air (Smells Like Mississippi)","This Friendly World","This Must Be The Place (Naive Melody)","Trouble","Use Me","Vampire Blues","Wish You Were Here","Weak Brain, Narrow Mind"];

    /* â”€â”€â”€ HELPERS â”€â”€â”€ */
    const norm=n=>n.toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
    const getDateTheme=ds=>{const d=ds?new Date(ds+'T12:00:00'):new Date(),m=d.getMonth()+1,dy=d.getDate(),wr=(tm,td)=>Math.abs(d-new Date(d.getFullYear(),tm-1,td))/864e5<=4;if(m===2&&wr(2,14))return'valentine';if((m===6&&dy>=30)||(m===7&&dy<=8))return'july4th';if((m===12&&dy>=28)||(m===1&&dy<=5))return'newyear';return null};
    const isBeachCity=c=>{if(!c)return false;const l=c.toLowerCase();return BEACH_CITIES.some(b=>l.includes(b))};
    const fmtDate=d=>{if(!d||d==='Tonight')return'â€”';const[y,m,dy]=d.split('-');return`${m}/${dy}/${y.slice(-2)}`};
    /* Gap scoring: fat-tail bell curve peaking at gap 5, slow decay 1.2 (backtested improvement over peak-4) */
    const gapScore=gap=>{if(gap>=999||gap===Infinity)return 0;if(gap<=5)return Math.min(15,gap*3.0);return Math.max(0,15-(gap-5)*1.2)};
    const HR_SIZE=40,HR_BONUS=15,FREQ_WEIGHT=0.3,ENCORE_BONUS=10,HR_WINDOW=50;
    /* Encore-lock songs: >=70% of plays land in last 3 positions */
    const ENCORE_LOCKS=new Set(["End Of The Show","Expiration Day","Old Joe","You Wreck Me","Keep Me in Your Heart","I'm So Glad"]);

    /* â”€â”€â”€ BOTTOM SHEET â”€â”€â”€ */
    function Sheet({open,onClose,title,titleColor,level,children}){
      const z=level===2?1000:900;
      return(<>{React.createElement('div',{className:`sheet-bg ${open?'on':''}`,onClick:onClose,style:{zIndex:z}})}
        <div className={`sheet ${open?'on':''}`} style={{zIndex:z+50,pointerEvents:open?'auto':'none'}}><div className="sheet-bar"/><div className="sheet-hd"><h3 style={{color:titleColor||'var(--orange)'}}>{title}</h3><button className="sheet-x" onClick={onClose}>Ã—</button></div><div className="sheet-bd">{children}</div></div></>);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function App(){
      const[tab,setTab]=useState('predict');
      const[setlists,setSetlists]=useState([]);
      const[liveSets,setLiveSets]=useState({set1:[],set2:[],encore:[]});
      const[liveCurrentSet,setLiveCurrentSet]=useState('set1');
      const[liveEditMode,setLiveEditMode]=useState(false);
      const[customSongs,setCustomSongs]=useState([]);
      const[themeSongs,setThemeSongs]=useState({});
      const[loadState,setLoadState]=useState('loading'); // loading | ok | error
      const[loadError,setLoadError]=useState('');
      const[searchTerm,setSearchTerm]=useState('');
      const[quickAdd,setQuickAdd]=useState('');
      const[sortBy,setSortBy]=useState('showsSince');
      const[newDate,setNewDate]=useState('');
      const[newSongs,setNewSongs]=useState('');
      const[currentRun,setCurrentRun]=useState(null);
      const[editingSetlist,setEditingSetlist]=useState(null);
      const[unmatchedSongs,setUnmatchedSongs]=useState([]);
      const[editingTheme,setEditingTheme]=useState(null);
      const[themeSearchTerm,setThemeSearchTerm]=useState('');
      const[songSheet,setSongSheet]=useState(null);
      const[detailSheet,setDetailSheet]=useState(null);
      const[allSongsSheet,setAllSongsSheet]=useState(false);
      const[themeSheet,setThemeSheet]=useState(false);

      const VENUE='Moody Center',CITY='Austin',STATE='TX',DATE1='2026-02-14',DATE2='2026-02-15',NIGHTS=2;

      const ALL_WITH=useMemo(()=>[...new Set([...ALL_SONGS,...COMMON_COVERS,...customSongs])].sort(),[customSongs]);

      const findMatch=useCallback(input=>{
        const n=norm(input);
        const ex=ALL_WITH.find(s=>norm(s)===n);if(ex)return ex;
        if(n.length>=5){const p=ALL_WITH.find(s=>norm(s).includes(n)||n.includes(norm(s)));if(p)return p}
        else{const w=ALL_WITH.find(s=>norm(s).split(/\s+/).includes(n));if(w)return w}
        return null;
      },[ALL_WITH]);

      /* â”€â”€â”€ LOAD DATA â”€â”€â”€ */
      useEffect(()=>{
        (async()=>{
          setLoadState('loading');setLoadError('');
          try{
            const sr=await fetch('/setlists.json');
            if(!sr.ok){setLoadError(`setlists.json: HTTP ${sr.status}`);setLoadState('error');return}
            const tr=await fetch('/theme-songs.json');
            if(!tr.ok){setLoadError(`theme-songs.json: HTTP ${tr.status}`);setLoadState('error');return}
            const sd=await sr.json(),td=await tr.json();
            if(!sd.setlists||!sd.setlists.length){setLoadError('setlists.json loaded but contains no setlists');setLoadState('error');return}
            setSetlists(sd.setlists);
            const lp=localStorage.getItem('panicSetlists');
            if(lp){const p=JSON.parse(lp);setCustomSongs(p.customSongs||[]);const mt={...td};if(p.themeEdits)Object.keys(p.themeEdits).forEach(k=>{mt[k]=p.themeEdits[k]});setThemeSongs(mt)}
            else setThemeSongs(td);
            setLoadState('ok');
          }catch(e){
            console.error('Load failed:',e);
            setLoadError(e.message||'Network error');
            // Try localStorage fallback
            const s=localStorage.getItem('panicSetlists');
            if(s){try{const d=JSON.parse(s);if(d.setlists&&d.setlists.length){setSetlists(d.setlists);setCustomSongs(d.customSongs||[]);setThemeSongs(d.themeSongs||DEFAULT_THEME_SONGS);setLoadState('ok');setLoadError('Using cached data (fetch failed: '+e.message+')');return}}catch(e2){}}
            setLoadState('error');
          }
        })();
      },[]);

      useEffect(()=>{
        const e=JSON.parse(localStorage.getItem('panicSetlists')||'{}');
        localStorage.setItem('panicSetlists',JSON.stringify({...e,currentRun,customSongs}));
      },[currentRun,customSongs]);

      /* â”€â”€â”€ SONG STATUS â”€â”€â”€ */
      const songStatus=useMemo(()=>{
        const st={};ALL_WITH.forEach(s=>{st[s]={available:true,lastPlayed:null,showsSince:Infinity,timesPlayed:0,playFrequency:0}});
        const sorted=[...setlists].sort((a,b)=>new Date(b.date)-new Date(a.date));
        sorted.forEach(sl=>{[...new Set(sl.songs)].forEach(s=>{if(st[s])st[s].timesPlayed++})});
        const total=sorted.length;
        if(total>0)ALL_WITH.forEach(s=>{if(st[s])st[s].playFrequency=(st[s].timesPlayed/total)*100});
        sorted.forEach((sl,i)=>{sl.songs.forEach(s=>{if(st[s]&&st[s].showsSince===Infinity){st[s].showsSince=i;st[s].lastPlayed=sl.date;st[s].available=i>=3}})});
        const pairs=themeSongs['sequentialPairs']||[];
        const last3=sorted.slice(0,3);const recent=new Set();last3.forEach(sl=>sl.songs.forEach(s=>recent.add(s)));
        pairs.forEach(p=>{if(p.includes('<->')){const[a,b]=p.split('<->').map(s=>s.trim());
          if(recent.has(a)&&st[b]&&st[a].showsSince!==Infinity){st[b].showsSince=Math.min(st[b].showsSince,st[a].showsSince);st[b].available=st[b].showsSince>=3;st[b].lastPlayed=st[a].lastPlayed}
          if(recent.has(b)&&st[a]&&st[b].showsSince!==Infinity){st[a].showsSince=Math.min(st[a].showsSince,st[b].showsSince);st[a].available=st[a].showsSince>=3;st[a].lastPlayed=st[b].lastPlayed}
        }});
        return st;
      },[setlists,themeSongs,ALL_WITH]);

      const heavyRotation=useMemo(()=>{
        const recent=[...setlists].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,HR_WINDOW);
        const c={};recent.forEach(sl=>{[...new Set(sl.songs)].forEach(s=>{if(s!=='Drums'&&s!=='Jam')c[s]=(c[s]||0)+1})});
        return Object.entries(c).filter(([,n])=>n>=3).sort((a,b)=>b[1]-a[1]||a[0].localeCompare(b[0])).slice(0,HR_SIZE).map(([s])=>s);
      },[setlists]);

      const stats=useMemo(()=>{
        const a=Object.values(songStatus).filter(s=>s.available).length;
        const r=Object.values(songStatus).filter(s=>!s.available&&s.showsSince>0).length;
        const p=Object.values(songStatus).filter(s=>s.showsSince===0).length;
        return{available:a,resting:r,played:p,total:ALL_WITH.length};
      },[songStatus]);

      /* â”€â”€â”€ ACCURACY â”€â”€â”€ */
      const showAccuracy=useMemo(()=>{
        const sorted=[...setlists].sort((a,b)=>new Date(a.date)-new Date(b.date));
        const map={};
        sorted.forEach((target,ti)=>{
          if(ti<20){map[target.id]=null;return}
          const hist=sorted.slice(0,ti);
          const tDate=new Date(target.date),tCity=(target.city||'').toLowerCase().trim();
          const runShows=[];
          if(tCity){for(let i=ti-1;i>=0;i--){const p=sorted[i];if((p.city||'').toLowerCase().trim()===tCity&&(tDate-new Date(p.date))/864e5<=2)runShows.unshift(p);else if(runShows.length)break}}
          const runSongs=new Set();runShows.forEach(s=>[...new Set(s.songs)].forEach(sg=>runSongs.add(sg)));
          const hs={};ALL_WITH.forEach(s=>{hs[s]={available:true,lastPlayed:null,showsSince:Infinity,timesPlayed:0,playFrequency:0,playedInRun:runSongs.has(s)}});
          hist.forEach(sl=>{[...new Set(sl.songs)].forEach(s=>{if(hs[s])hs[s].timesPlayed++})});
          const th=hist.length;ALL_WITH.forEach(s=>{if(hs[s])hs[s].playFrequency=(hs[s].timesPlayed/th)*100});
          hist.forEach((sl,idx)=>{[...new Set(sl.songs)].forEach(s=>{if(hs[s]){hs[s].lastPlayedIndex=idx;hs[s].lastPlayed=sl.date}})});
          ALL_WITH.forEach(s=>{if(hs[s]){if(hs[s].lastPlayedIndex!==undefined){hs[s].showsSince=th-hs[s].lastPlayedIndex-1;hs[s].available=hs[s].showsSince>=3}else{hs[s].showsSince=Infinity;hs[s].available=true}}});
          const prs=themeSongs['sequentialPairs']||[];const l3=hist.slice(-3);const rH=new Set();l3.forEach(sl=>sl.songs.forEach(s=>rH.add(s)));
          prs.forEach(ps=>{if(ps.includes('<->')){const[a,b]=ps.split('<->').map(s=>s.trim());
            if(rH.has(a)&&hs[b]&&hs[a].showsSince!==Infinity){hs[b].showsSince=Math.min(hs[b].showsSince,hs[a].showsSince);hs[b].available=hs[b].showsSince>=3}
            if(rH.has(b)&&hs[a]&&hs[b].showsSince!==Infinity){hs[a].showsSince=Math.min(hs[a].showsSince,hs[b].showsSince);hs[a].available=hs[a].showsSince>=3}
          }});
          /* Recency-windowed HR: use last HR_WINDOW shows of history */
          const hrHist=hist.slice(-HR_WINDOW);
          const hrc={};hrHist.forEach(sl=>{[...new Set(sl.songs)].forEach(s=>{if(s!=='Drums'&&s!=='Jam')hrc[s]=(hrc[s]||0)+1})});
          const hhr=Object.entries(hrc).filter(([,n])=>n>=3).sort((a,b)=>b[1]-a[1]||a[0].localeCompare(b[0])).slice(0,HR_SIZE).map(([s])=>s);
          /* Recent plays for relaxed min-play threshold */
          const recentH=new Set();hist.slice(-25).forEach(sl=>sl.songs.forEach(s=>recentH.add(s)));
          const preds=Object.entries(hs).filter(([s,st])=>s!=='Drums'&&s!=='Jam'&&(st.timesPlayed>=2||(st.timesPlayed>=1&&recentH.has(s)))&&!st.playedInRun&&(st.available||st.showsSince===2))
            .map(([song,st])=>{let sc=st.playFrequency*FREQ_WEIGHT;if(hhr.includes(song))sc+=HR_BONUS;sc+=gapScore(st.showsSince);
              if(ENCORE_LOCKS.has(song)&&st.available)sc+=ENCORE_BONUS;
              if(hist.some(s=>s.city&&target.city&&s.city.toLowerCase()===target.city.toLowerCase()&&s.songs.includes(song)))sc+=30;
              const theme=getDateTheme(target.date);let tl=theme?(themeSongs[theme]||[]):[];if(isBeachCity(target.city))tl=[...tl,...(themeSongs['beach']||[])];if(tl.includes(song))sc+=30;
              return{song,score:sc}}).sort((a,b)=>b.score-a.score).slice(0,10).map(p=>p.song);
          const actual=[...new Set(target.songs)],matches=actual.filter(s=>preds.includes(s));
          map[target.id]={matches:matches.length,totalPredicted:10,totalPlayed:actual.length,predictionAccuracy:((matches.length/10)*100).toFixed(0),coverage:((matches.length/actual.length)*100).toFixed(0),predictions:preds,actualSongs:actual,matchedSongs:matches,runShows,songsPlayedInRun:Array.from(runSongs)};
        });
        return map;
      },[setlists,themeSongs,ALL_WITH]);

      /* â”€â”€â”€ PREDICTIONS â”€â”€â”€ */
      /* Improvements: fat-tail gap, encore bonus, recency HR, night-2 HR boost, relaxed min-play */
      const recentPlays=useMemo(()=>{const r=new Set();[...setlists].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,25).forEach(sl=>sl.songs.forEach(s=>r.add(s)));return r},[setlists]);
      const predictions=useMemo(()=>{
        const uc=`${CITY}, ${STATE}`.toLowerCase();
        return Object.entries(songStatus).filter(([s,st])=>s!=='Drums'&&s!=='Jam'&&(st.timesPlayed>=2||(st.timesPlayed>=1&&recentPlays.has(s)))&&(st.available||st.showsSince===2))
          .map(([song,st])=>{let sc=0;const n1=st.available,nights=n1?'both':'night2';
            sc+=st.playFrequency*FREQ_WEIGHT;if(heavyRotation.includes(song))sc+=HR_BONUS;sc+=gapScore(st.showsSince);
            if(ENCORE_LOCKS.has(song)&&st.available)sc+=ENCORE_BONUS;
            let isCity=false;(themeSongs['cityReferences']||[]).forEach(r=>{const[sn,cn]=r.split(':').map(s=>s.trim());if(sn===song&&uc.includes(cn.toLowerCase()))isCity=true});
            (themeSongs['stateReferences']||[]).forEach(r=>{const[sn,sc2]=r.split(':').map(s=>s.trim());if(sn===song&&uc.includes(sc2.toLowerCase()))isCity=true});
            if(isCity)sc+=30;const theme=getDateTheme(DATE1);const tl=theme?(themeSongs[theme]||[]):[];const isTheme=tl.includes(song);if(isTheme)sc+=30;if(nights==='night2')sc+=15;
            const tp=setlists.filter(sl=>sl.songs.includes(song)).length;
            return{song,score:sc,status:{...st,timesPlayed:tp},isCity,isTheme,theme,nights}})
          .sort((a,b)=>{if(a.nights==='both'&&b.nights==='night2')return-1;if(a.nights==='night2'&&b.nights==='both')return 1;return b.score-a.score}).slice(0,10);
      },[songStatus,heavyRotation,themeSongs,setlists,recentPlays]);

      /* â”€â”€â”€ ACTIONS â”€â”€â”€ */
      const showHistory=song=>{
        const dates=setlists.filter(sl=>sl.songs.includes(song)).map(sl=>({date:sl.date,city:sl.city||''})).sort((a,b)=>new Date(b.date)-new Date(a.date));
        setSongSheet({song,dates});
      };
      const allLiveSongs=useMemo(()=>[...liveSets.set1,...liveSets.set2,...liveSets.encore],[liveSets]);
      const addToLive=song=>{
        const allSongs=[...liveSets.set1,...liveSets.set2,...liveSets.encore];
        if(!allSongs.includes(song))setLiveSets(p=>({...p,[liveCurrentSet]:[...p[liveCurrentSet],song]}));
        setQuickAdd('');
      };
      const removeFromLive=(song,setKey)=>setLiveSets(p=>({...p,[setKey]:p[setKey].filter(s=>s!==song)}));
      const saveLive=()=>{
        const allSongs=[...liveSets.set1,...liveSets.set2,...liveSets.encore];
        if(!allSongs.length)return;
        const sl={date:new Date().toISOString().split('T')[0],songs:allSongs,city:`${CITY}, ${STATE}`,id:Date.now()};
        setSetlists(p=>[sl,...p].sort((a,b)=>new Date(b.date)-new Date(a.date)));
        setLiveSets({set1:[],set2:[],encore:[]});setLiveCurrentSet('set1');setLiveEditMode(false);setTab('shows');
      };
      const predSongNames=useMemo(()=>predictions.map(p=>p.song),[predictions]);
      const liveHits=useMemo(()=>{
        return allLiveSongs.filter(s=>predSongNames.includes(s));
      },[allLiveSongs,predSongNames]);

      const addSetlist=()=>{
        if(!newSongs)return;let eDate=newDate,eCity=currentRun?.city||'',eVenue='',sText=newSongs;
        const lines=newSongs.split('\n').map(l=>l.trim()).filter(l=>l);
        const dm=lines[0]?.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})\s+(.+?),\s*([^,]+?)(?:,\s*([A-Z]{2}))?$/);
        if(dm){const[,mo,dy,yr,v,c,st]=dm;const fy=yr.length===2?`20${yr}`:yr;eDate=`${fy}-${mo.padStart(2,'0')}-${dy.padStart(2,'0')}`;if(v)eVenue=v.trim();if(c){eCity=st?`${c.trim()}, ${st}`:c.trim()}sText=lines.slice(1).join('\n').trim()}
        if(!eDate){alert('Please include a date.');return}
        if(!confirm(`Date: ${eDate}\n${eVenue?'Venue: '+eVenue+'\n':''}${eCity?'City: '+eCity+'\n':''}Proceed?`))return;
        const raw=sText.split(/[,\n>]/).map(s=>s.trim()).filter(s=>s.length>0)
          .map(s=>s.replace(/^(1|2|3|E\d?):\s*/,'').trim()).map(s=>s.replace(/\d+:$/,'').trim()).map(s=>s.replace(/\*+$/,'').trim())
          .filter(s=>!s.match(/^(1|2|3|E\d?):?$/)).filter(s=>!['Set','Set 1','Set 2','Set 3','Encore'].includes(s))
          .filter(s=>{if(s.match(/^[A-Z]{2}$/)||s.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/))return false;
            if(eCity){const cl=eCity.toLowerCase(),sl=s.toLowerCase();if(sl===cl||cl.includes(sl)||sl.includes(cl)||cl.split(/[\s,]+/).includes(sl))return false}
            if(eVenue){const vl=eVenue.toLowerCase(),sl=s.toLowerCase();if(vl.includes(sl)||sl.includes(vl)||vl.split(/[\s,]+/).includes(sl))return false}
            return true}).filter(s=>s.length>0);
        const matched=[],unmatched=[],newC=[];
        raw.forEach(r=>{const m=findMatch(r);if(m){matched.push(m);if(!ALL_SONGS.includes(m)&&!COMMON_COVERS.includes(m))newC.push(m)}else unmatched.push(r)});
        if(newC.length)setCustomSongs(p=>[...new Set([...p,...newC])]);
        if(unmatched.length){setUnmatchedSongs(unmatched);setNewDate(eDate);return}
        setSetlists(p=>[{date:eDate,songs:matched,city:eCity,venue:eVenue,id:Date.now()},...p].sort((a,b)=>new Date(b.date)-new Date(a.date)));
        setNewDate('');setNewSongs('');
      };

      const addUnmatchedAndContinue=()=>{
        setCustomSongs(p=>[...p,...unmatchedSongs]);
        const all=newSongs.split(/[,\n>]/).map(s=>s.trim()).filter(s=>s.length>0).filter(s=>!['1:','2:','3:','E:','Set','Set 1','Set 2','Set 3','Encore'].includes(s)).map(s=>s.replace(/\*+$/,'').trim())
          .map(r=>{const db=[...ALL_SONGS,...COMMON_COVERS,...customSongs,...unmatchedSongs];return db.find(s=>norm(s)===norm(r)||norm(s).includes(norm(r))||norm(r).includes(norm(s)))||r});
        setSetlists(p=>[{date:newDate,songs:all,city:currentRun?.city||'',id:Date.now()},...p].sort((a,b)=>new Date(b.date)-new Date(a.date)));
        setUnmatchedSongs([]);setNewDate('');setNewSongs('');
      };
      const skipUnmatched=()=>{
        const m=newSongs.split(/[,\n>]/).map(s=>s.trim()).filter(s=>s.length>0).filter(s=>!['1:','2:','3:','E:','Set','Set 1','Set 2','Set 3','Encore'].includes(s)).map(s=>s.replace(/\*+$/,'').trim()).map(findMatch).filter(s=>s);
        setSetlists(p=>[{date:newDate,songs:m,city:currentRun?.city||'',id:Date.now()},...p].sort((a,b)=>new Date(b.date)-new Date(a.date)));
        setUnmatchedSongs([]);setNewDate('');setNewSongs('');
      };
      const delSetlist=id=>{if(confirm('Delete this setlist?'))setSetlists(p=>p.filter(s=>s.id!==id))};
      const saveEditSetlist=()=>{
        if(!editingSetlist)return;
        const raw=editingSetlist.editSongs.split(/[\n,]/).map(s=>s.trim()).filter(s=>s.length>0);
        const matched=[],unmatched=[],newC=[];
        raw.forEach(r=>{const m=findMatch(r);if(m){matched.push(m);if(!ALL_SONGS.includes(m)&&!COMMON_COVERS.includes(m))newC.push(m)}else{matched.push(r);newC.push(r)}});
        if(newC.length)setCustomSongs(p=>[...new Set([...p,...newC])]);
        setSetlists(p=>p.map(sl=>sl.id===editingSetlist.id?{...sl,date:editingSetlist.editDate,city:editingSetlist.editCity,songs:matched}:sl));
        setEditingSetlist(null);
      };

      // Theme editing
      const startThemeEdit=(k,l)=>{setEditingTheme({key:k,label:l,songs:[...(themeSongs[k]||[])]});setThemeSearchTerm('');setThemeSheet(true)};
      const addToTheme=s=>{if(editingTheme&&!editingTheme.songs.includes(s))setEditingTheme({...editingTheme,songs:[...editingTheme.songs,s]})};
      const removeFromTheme=s=>{if(editingTheme)setEditingTheme({...editingTheme,songs:editingTheme.songs.filter(x=>x!==s)})};
      const saveTheme=()=>{
        if(!editingTheme)return;const u={...themeSongs,[editingTheme.key]:editingTheme.songs};setThemeSongs(u);
        const lp=JSON.parse(localStorage.getItem('panicSetlists')||'{}');lp.themeEdits=lp.themeEdits||{};lp.themeEdits[editingTheme.key]=editingTheme.songs;
        localStorage.setItem('panicSetlists',JSON.stringify(lp));setEditingTheme(null);setThemeSheet(false);
      };

      const filteredSongs=useMemo(()=>{
        let songs=ALL_WITH.filter(s=>s.toLowerCase().includes(searchTerm.toLowerCase()));
        if(sortBy==='likelihood')songs.sort((a,b)=>{const aS=songStatus[a],bS=songStatus[b];
          let aScore=aS.playFrequency*FREQ_WEIGHT+(heavyRotation.includes(a)?HR_BONUS:0)+gapScore(aS.showsSince)+(ENCORE_LOCKS.has(a)&&aS.available?ENCORE_BONUS:0);
          let bScore=bS.playFrequency*FREQ_WEIGHT+(heavyRotation.includes(b)?HR_BONUS:0)+gapScore(bS.showsSince)+(ENCORE_LOCKS.has(b)&&bS.available?ENCORE_BONUS:0);
          return bScore!==aScore?bScore-aScore:a.localeCompare(b)});
        else if(sortBy==='timesPlayed')songs.sort((a,b)=>songStatus[b].timesPlayed-songStatus[a].timesPlayed||a.localeCompare(b));
        else if(sortBy==='showsSince')songs.sort((a,b)=>{const aS=songStatus[a],bS=songStatus[b];
          if((aS.timesPlayed>=3)!==(bS.timesPlayed>=3))return aS.timesPlayed>=3?-1:1;
          if(aS.timesPlayed>=3&&bS.timesPlayed>=3){const aA=aS.showsSince>2,bA=bS.showsSince>2;if(aA!==bA)return aA?-1:1;if(aA&&bS.showsSince!==aS.showsSince)return bS.showsSince-aS.showsSince}
          return a.localeCompare(b)});
        else songs.sort();
        return songs;
      },[searchTerm,sortBy,songStatus,heavyRotation,ALL_WITH]);

      const quickResults=quickAdd?ALL_WITH.filter(s=>s.toLowerCase().includes(quickAdd.toLowerCase())).slice(0,15):[];
      const quickAddNoMatch=quickAdd.length>=2&&quickResults.length===0;
      const theme=getDateTheme(DATE1);
      const themeInfo={valentine:{e:'ğŸ’œ',l:"Valentine's",c:'#a855f7'},july4th:{e:'ğŸ†',l:'July 4th',c:'#ef4444'},newyear:{e:'ğŸ‰',l:"New Year's",c:'#eab308'}}[theme];

      /* â”€â”€â”€ STYLES â”€â”€â”€ */
      const chip=(c)=>({display:'inline-block',padding:'2px 8px',borderRadius:10,fontSize:'.68rem',fontWeight:700,letterSpacing:'.04em',textTransform:'uppercase',background:`${c}22`,color:c,whiteSpace:'nowrap'});
      const row=(bg,bdr)=>({padding:'.85rem 1rem',borderRadius:10,marginBottom:'.4rem',background:bg||'var(--bg3)',border:`1px solid ${bdr||'var(--bdr)'}`,display:'flex',justifyContent:'space-between',alignItems:'center',minHeight:52,cursor:'pointer',transition:'all .15s'});
      const predRow=(isT,isC)=>({...row(isT?'rgba(168,85,247,.12)':isC?'rgba(255,140,66,.12)':'var(--bg3)',isT?'var(--purple)':isC?'var(--orange)':'var(--bdr)'),borderLeft:`4px solid ${isT?'var(--purple)':isC?'var(--orange)':'var(--yellow)'}`});
      const input={width:'100%',padding:'.85rem 1rem',background:'var(--bg3)',border:'1px solid var(--bdr)',borderRadius:10,color:'var(--t1)',fontFamily:"'Crimson Pro',serif",fontSize:'1rem',outline:'none'};
      const statBox=c=>({flex:1,padding:'.75rem .5rem',borderRadius:10,textAlign:'center',background:`${c}0D`,border:`1px solid ${c}33`});
      const sTitle={fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.6rem',letterSpacing:'.06em',color:'var(--orange)',marginBottom:'.75rem'};
      const tabBtn=a=>({display:'flex',flexDirection:'column',alignItems:'center',gap:2,background:'none',border:'none',cursor:'pointer',padding:'4px 12px',color:a?'var(--orange)':'var(--t3)',fontSize:'.65rem',fontFamily:"'Crimson Pro',serif",fontWeight:a?700:400,letterSpacing:'.04em',transition:'color .15s',position:'relative'});

      const tabs=[{id:'predict',ic:'ğŸ¯',l:'Predict'},{id:'live',ic:'ğŸ¸',l:'Live'},{id:'songs',ic:'ğŸµ',l:'Songs'},{id:'shows',ic:'ğŸ“‹',l:'Shows'},{id:'settings',ic:'âš™ï¸',l:'Settings'}];
      const contentRef=useRef(null);
      const switchTab=id=>{setTab(id);setSearchTerm('');if(contentRef.current)contentRef.current.scrollTop=0};

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // RENDER
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      return(
        <div className="app-shell" style={{display:'flex',flexDirection:'column',height:'100%'}}>
          {/* â•â•â• SIDEBAR (desktop) â•â•â• */}
          <nav className="side-nav" style={{display:'none',flexDirection:'column',width:'var(--sidebar-w,200px)',height:'100%',background:'var(--bg2)',borderRight:'1px solid var(--bdr)',padding:'1.5rem 0',flexShrink:0,position:'fixed',left:0,top:0,bottom:0,zIndex:800}}>
            <div style={{padding:'0 1.25rem 1.5rem',borderBottom:'1px solid var(--bdr)',marginBottom:'.75rem'}}>
              <h1 style={{fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.5rem',letterSpacing:'.06em',lineHeight:1,background:'linear-gradient(135deg,var(--red),var(--orange),var(--yellow))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>Panic<br/>Predictor</h1>
            </div>
            {tabs.map(t=>(
              <button key={t.id} onClick={()=>switchTab(t.id)} style={{display:'flex',alignItems:'center',gap:'.75rem',width:'100%',padding:'.85rem 1.25rem',background:tab===t.id?'rgba(255,140,66,.1)':'transparent',border:'none',borderLeft:tab===t.id?'3px solid var(--orange)':'3px solid transparent',cursor:'pointer',color:tab===t.id?'var(--orange)':'var(--t3)',fontFamily:"'Crimson Pro',serif",fontSize:'.95rem',fontWeight:tab===t.id?700:400,letterSpacing:'.02em',transition:'all .15s',textAlign:'left',position:'relative'}}>
                <span style={{fontSize:'1.25rem',lineHeight:1,width:'1.5rem',textAlign:'center'}}>{t.ic}</span>
                <span>{t.l}</span>
                {t.id==='live'&&allLiveSongs.length>0&&<span style={{width:8,height:8,borderRadius:'50%',background:'var(--green)',boxShadow:'0 0 6px var(--green)',marginLeft:'auto'}}/>}
              </button>
            ))}
            <div style={{marginTop:'auto',padding:'1rem 1.25rem',borderTop:'1px solid var(--bdr)',fontSize:'.73rem',color:'var(--t3)'}}>
              {setlists.length} shows loaded
            </div>
          </nav>

          <div ref={contentRef} className="app-content" style={{flex:1,overflowY:'auto',WebkitOverflowScrolling:'touch',paddingBottom:'calc(var(--tab-h) + var(--safe-b) + 12px)',marginLeft:'var(--sidebar-w,0px)'}}>

            {/* Loading / Error states */}
            {loadState==='loading'&&(
              <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'60vh',gap:'1rem'}}>
                <div style={{fontSize:'2.5rem',animation:'blink 1s ease-in-out infinite'}}>ğŸ¸</div>
                <div style={{fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.3rem',color:'var(--orange)',letterSpacing:'.06em'}}>Loading setlists...</div>
              </div>
            )}
            {loadState==='error'&&(
              <div style={{margin:'1rem',padding:'1rem',borderRadius:12,background:'rgba(248,113,113,.1)',border:'1px solid var(--played)'}}>
                <div style={{fontWeight:700,color:'var(--played)',marginBottom:'.35rem',fontSize:'.95rem'}}>âš ï¸ Failed to load data</div>
                <div style={{fontSize:'.85rem',color:'var(--t2)',marginBottom:'.75rem',wordBreak:'break-word'}}>{loadError}</div>
                <div style={{fontSize:'.8rem',color:'var(--t3)',marginBottom:'.75rem'}}>Try opening directly: <a href="https://neilgolson.com/setlists.json" target="_blank" style={{color:'var(--orange)'}}>setlists.json</a></div>
                <button onClick={()=>window.location.reload()} style={{padding:'.6rem 1.2rem',borderRadius:8,border:'none',background:'var(--played)',color:'#fff',fontFamily:"'Bebas Neue',sans-serif",fontSize:'.95rem',cursor:'pointer'}}>Retry</button>
              </div>
            )}
            {loadError&&loadState==='ok'&&(
              <div style={{margin:'1rem 1rem 0',padding:'.6rem .8rem',borderRadius:8,background:'rgba(251,191,36,.1)',border:'1px solid var(--rest)',fontSize:'.8rem',color:'var(--rest)'}}>
                âš ï¸ {loadError}
              </div>
            )}
            {/* â•â•â• PREDICT â•â•â• */}
            <div style={{display:tab==='predict'&&loadState==='ok'?'block':'none',padding:'1rem 1rem 0'}}>
                <div style={{textAlign:'center',marginBottom:'1.25rem',paddingTop:'.5rem'}}>
                  <h1 style={{fontFamily:"'Bebas Neue',sans-serif",fontSize:'2.4rem',letterSpacing:'.08em',lineHeight:1,background:'linear-gradient(135deg,var(--red),var(--orange),var(--yellow))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>Panic Predictor</h1>
                  <p style={{color:'var(--t3)',fontSize:'.85rem',marginTop:'.25rem'}}>3-show rule â€¢ {setlists.length} shows loaded</p>
                </div>
                {/* Next Run */}
                <div style={{padding:'.75rem 1rem',borderRadius:14,marginBottom:'1.15rem',background:'linear-gradient(135deg,rgba(255,51,102,.08),rgba(255,140,66,.08))',border:'1px solid rgba(255,140,66,.2)'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'baseline'}}>
                    <div style={{fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.15rem',letterSpacing:'.04em',color:'var(--orange)'}}>
                      {new Date(DATE1+'T12:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric'})}{NIGHTS>1&&`â€“${new Date(DATE2+'T12:00:00').toLocaleDateString('en-US',{day:'numeric'})}`}
                    </div>
                    {themeInfo&&<span style={{...chip(themeInfo.c),fontSize:'.72rem',padding:'3px 8px'}}>{themeInfo.e} {themeInfo.l}</span>}
                  </div>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'baseline',marginTop:'.2rem'}}>
                    <div style={{fontSize:'.9rem',color:'var(--t2)'}}>ğŸ“ {VENUE} â€¢ {CITY}, {STATE}</div>
                    <span style={{fontSize:'.78rem',color:'var(--t3)'}}>{NIGHTS}-night run</span>
                  </div>
                </div>
                {/* Top 10 */}
                <div style={sTitle}>ğŸ¸ Top 10 Predictions</div>
                {predictions.length===0?<div style={{color:'var(--t3)',padding:'2rem',textAlign:'center'}}>Add setlists to see predictions</div>:
                  <div className="pred-grid">
                  {predictions.map(({song,status:st,isCity,isTheme,theme:th,nights},i)=>{
                    const ico=isTheme?(th==='valentine'?'ğŸ’œ':th==='july4th'?'ğŸ†':th==='newyear'?'ğŸ‰':'ğŸµ'):isCity?'ğŸ“':'';
                    return(
                      <div key={song} style={predRow(isTheme,isCity)} onClick={()=>showHistory(song)}>
                        <div style={{flex:1,minWidth:0}}>
                          <div style={{fontSize:'1.02rem',fontWeight:600,display:'flex',alignItems:'center',gap:'.3rem'}}>
                            <span style={{color:'var(--t3)',fontSize:'.8rem',minWidth:'1.3rem'}}>{i+1}.</span>
                            <span style={{overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{song}</span>
                            {ico&&<span style={{fontSize:'.85rem',flexShrink:0}}>{ico}</span>}
                            {nights==='night2'&&<span style={{...chip('var(--orange)'),fontSize:'.58rem',padding:'1px 5px'}}>N2</span>}
                          </div>
                        </div>
                        <div style={{display:'flex',gap:'.7rem',alignItems:'center',flexShrink:0}}>
                          <span style={{fontSize:'.73rem',color:'#fff'}}>{fmtDate(st.lastPlayed)}</span>
                          <span style={{fontSize:'.73rem',color:'#fff'}}>{Math.floor(st.timesPlayed)}Ã—</span>
                        </div>
                      </div>)
                  })}
                  </div>}
            </div>

            {/* â•â•â• LIVE â•â•â• */}
            <div style={{display:tab==='live'&&loadState==='ok'?'block':'none',padding:'1rem 1rem 0'}}>
                <div style={{display:'flex',alignItems:'center',gap:'.7rem',marginBottom:'1rem',paddingTop:'.5rem'}}>
                  <div style={{width:12,height:12,borderRadius:'50%',background:'var(--green)',boxShadow:'0 0 8px var(--green)',animation:'blink 1.2s ease-in-out infinite'}}/>
                  <h2 style={{fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.8rem',color:'var(--green)',letterSpacing:'.06em'}}>Live Show</h2>
                  <span style={{fontSize:'.85rem',color:'var(--t3)',marginLeft:'auto'}}>{allLiveSongs.length} songs</span>
                </div>

                {/* Prediction hit counter */}
                {allLiveSongs.length>0&&(
                  <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:'.5rem',marginBottom:'1rem',padding:'.6rem 1rem',borderRadius:10,background:liveHits.length>=5?'rgba(74,222,128,.15)':liveHits.length>=3?'rgba(234,179,8,.12)':'rgba(255,140,66,.1)',border:`1px solid ${liveHits.length>=5?'var(--green)':liveHits.length>=3?'var(--rest)':'var(--orange)'}`}}>
                    <span style={{fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.6rem',color:liveHits.length>=5?'var(--green)':liveHits.length>=3?'var(--rest)':'var(--orange)'}}>{liveHits.length}/10</span>
                    <span style={{fontSize:'.85rem',color:'var(--t2)'}}>Predicted</span>
                  </div>
                )}

                {/* Set indicator tabs */}
                <div style={{display:'flex',gap:'.35rem',marginBottom:'.75rem'}}>
                  {[{key:'set1',label:'Set 1'},{key:'set2',label:'Set 2'},{key:'encore',label:'Encore'}].map(s=>{
                    const isActive=liveCurrentSet===s.key;
                    const count=liveSets[s.key].length;
                    return(
                      <button key={s.key} onClick={()=>setLiveCurrentSet(s.key)} style={{flex:1,padding:'.6rem .5rem',borderRadius:8,border:isActive?'1px solid var(--green)':'1px solid var(--bdr)',background:isActive?'rgba(74,222,128,.15)':'var(--bg3)',color:isActive?'var(--green)':'var(--t3)',fontFamily:"'Bebas Neue',sans-serif",fontSize:'.95rem',letterSpacing:'.04em',cursor:'pointer',transition:'all .15s',position:'relative'}}>
                        {s.label}{count>0&&<span style={{marginLeft:'.35rem',fontSize:'.75rem',opacity:.7}}>({count})</span>}
                        {isActive&&<div style={{position:'absolute',bottom:-1,left:'20%',right:'20%',height:2,background:'var(--green)',borderRadius:1}}/>}
                      </button>
                    );
                  })}
                </div>

                {/* Search */}
                <div style={{position:'relative',marginBottom:'1rem'}}>
                  <input type="text" placeholder="ğŸ” Search song to add..." value={quickAdd} onChange={e=>setQuickAdd(e.target.value)}
                    onKeyDown={e=>{if(e.key==='Enter'){if(quickResults.length>0)addToLive(quickResults[0]);else if(quickAddNoMatch){const name=quickAdd.trim();setCustomSongs(p=>[...new Set([...p,name])]);addToLive(name)}}}}
                    style={{...input,borderColor:quickAdd?'var(--green)':'var(--bdr)'}}/>
                  {quickAdd&&(quickResults.length>0||quickAddNoMatch)&&(
                    <div style={{position:'absolute',top:'100%',left:0,right:0,zIndex:100,background:'var(--bg2)',border:'1px solid var(--bdr)',borderRadius:10,marginTop:4,maxHeight:'50vh',overflow:'auto',boxShadow:'0 8px 24px rgba(0,0,0,.5)'}}>
                      {quickResults.map(song=>{const added=allLiveSongs.includes(song),st=songStatus[song];return(
                        <div key={song} onClick={()=>!added&&addToLive(song)} style={{padding:'.85rem 1rem',borderBottom:'1px solid var(--bdr)',display:'flex',justifyContent:'space-between',alignItems:'center',opacity:added?.4:1,cursor:added?'default':'pointer',minHeight:48}}>
                          <span style={{fontSize:'1rem'}}>{song}</span>
                          {added?<span style={chip('var(--green)')}>Added</span>:!st?.available?<span style={chip('var(--rest)')}>Resting</span>:null}
                        </div>)})}
                      {quickAddNoMatch&&(
                        <div onClick={()=>{const name=quickAdd.trim();setCustomSongs(p=>[...new Set([...p,name])]);addToLive(name)}} style={{padding:'.85rem 1rem',display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer',minHeight:48,background:'rgba(168,85,247,.08)',borderTop:quickResults.length>0?'1px solid var(--bdr)':'none'}}>
                          <span style={{fontSize:'1rem',color:'var(--purple)'}}>+ Create "{quickAdd.trim()}"</span>
                          <span style={chip('var(--purple)')}>New Song</span>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Live Setlist Display */}
                {allLiveSongs.length>0?(
                  <div style={{marginBottom:'1rem'}}>
                    {/* Show header + edit toggle */}
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.75rem',paddingBottom:'.5rem',borderBottom:'1px solid var(--bdr)'}}>
                      <div style={{fontSize:'.9rem',color:'var(--t2)'}}>{new Date(DATE1+'T12:00:00').toLocaleDateString('en-US',{month:'numeric',day:'numeric',year:'2-digit'})} {VENUE}, {CITY}, {STATE}</div>
                      <button onClick={()=>setLiveEditMode(p=>!p)} style={{background:'none',border:'1px solid var(--bdr)',borderRadius:6,color:liveEditMode?'var(--played)':'var(--t3)',cursor:'pointer',fontSize:'.78rem',padding:'.35rem .75rem',fontFamily:"'Crimson Pro',serif",flexShrink:0,marginLeft:'.5rem'}}>
                        {liveEditMode?'Done':'âœ Edit'}
                      </button>
                    </div>
                    {/* Formatted setlist */}
                    {[{key:'set1',label:'1'},{key:'set2',label:'2'},{key:'encore',label:'E'}].map(s=>{
                      const songs=liveSets[s.key];
                      if(songs.length===0)return null;
                      const predSongs=predSongNames;
                      return(
                        <div key={s.key} style={{marginBottom:'.75rem'}}>
                          <div style={{display:'flex',alignItems:'baseline',gap:'.5rem',padding:'.5rem 0'}}>
                            <span style={{fontSize:'.95rem',color:'var(--t2)',flexShrink:0}}>{s.label}:</span>
                            {liveEditMode?(
                              <div style={{flex:1}}>
                                {songs.map((song,i)=>{
                                  const isPred=predSongs.includes(song);
                                  return(
                                    <div key={i} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'.4rem .5rem',marginBottom:'.25rem',borderRadius:6,background:isPred?'rgba(74,222,128,.12)':'var(--bg3)',border:isPred?'1px solid rgba(74,222,128,.3)':'1px solid var(--bdr)'}}>
                                      <span style={{fontSize:'.9rem',color:isPred?'var(--green)':'var(--t1)',fontWeight:isPred?600:400}}>{song}</span>
                                      <button onClick={()=>removeFromLive(song,s.key)} style={{background:'none',border:'none',color:'var(--played)',cursor:'pointer',fontSize:'1rem',padding:'.25rem .5rem',lineHeight:1}}>âœ•</button>
                                    </div>
                                  );
                                })}
                              </div>
                            ):(
                              <div style={{flex:1,fontSize:'.95rem',lineHeight:1.7}}>
                                {songs.map((song,i)=>{
                                  const isPred=predSongs.includes(song);
                                  return(
                                    <span key={i}>
                                      <span onClick={()=>showHistory(song)} style={{cursor:'pointer',color:isPred?'var(--green)':'var(--t2)',fontWeight:isPred?700:400,borderBottom:isPred?'1px solid var(--green)':'none'}}>{song}</span>
                                      {i<songs.length-1&&<span style={{color:'var(--t3)'}}>, </span>}
                                    </span>
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ):(
                  <div style={{textAlign:'center',padding:'3rem 1rem',color:'var(--t3)'}}>
                    <div style={{fontSize:'3rem',marginBottom:'.5rem'}}>ğŸ¸</div>
                    <p style={{fontSize:'1.02rem'}}>Search and tap songs as they're played</p>
                    <p style={{fontSize:'.85rem',marginTop:'.5rem',color:'var(--t3)'}}>Use the set tabs above to switch between sets</p>
                  </div>
                )}

                {/* Action buttons */}
                {allLiveSongs.length>0&&(
                  <div style={{display:'flex',gap:'.5rem'}}>
                    <button onClick={saveLive} style={{flex:1,padding:'.85rem',borderRadius:10,border:'1px solid rgba(74,222,128,.4)',background:'rgba(74,222,128,.12)',color:'var(--green)',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.1rem',letterSpacing:'.06em',cursor:'pointer',fontWeight:700}}>Save Show</button>
                    <button onClick={()=>{if(confirm('Clear all sets?')){setLiveSets({set1:[],set2:[],encore:[]});setLiveCurrentSet('set1');setLiveEditMode(false)}}} style={{padding:'.85rem 1.2rem',borderRadius:10,background:'var(--bg3)',border:'1px solid var(--bdr)',color:'var(--t2)',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1.1rem',cursor:'pointer'}}>Clear</button>
                  </div>
                )}
            </div>

            {/* â•â•â• SONGS â•â•â• */}
            <div style={{display:tab==='songs'&&loadState==='ok'?'block':'none',padding:'1rem 1rem 0'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',paddingTop:'.5rem',marginBottom:'1rem'}}>
                  <h2 style={sTitle}>All Songs</h2>
                  <span style={{fontSize:'.85rem',color:'var(--t3)'}}>{filteredSongs.length}{searchTerm?` / ${ALL_WITH.length}`:''}</span>
                </div>
                <div style={{display:'flex',gap:'.5rem',marginBottom:'1rem'}}>
                  {[{v:stats.available,l:'AVAILABLE',c:'var(--avail)'},{v:stats.resting,l:'RESTING',c:'var(--rest)'},{v:stats.played,l:'JUST PLAYED',c:'var(--played)'}].map(s=>(
                    <div key={s.l} style={statBox(s.c)}>
                      <div style={{fontFamily:"'Bebas Neue',sans-serif",fontSize:'2rem',lineHeight:1,color:s.c}}>{s.v}</div>
                      <div style={{fontSize:'.68rem',color:'var(--t3)',marginTop:2}}>{s.l}</div>
                    </div>
                  ))}
                </div>
                <input type="text" placeholder="ğŸ” Search..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} style={{...input,marginBottom:'.5rem'}}/>
                <select value={sortBy} onChange={e=>setSortBy(e.target.value)} style={{...input,fontSize:'.85rem',padding:'.6rem .8rem',marginBottom:'1rem',color:'var(--t2)'}}>
                  <option value="showsSince">Sort by Shows Since Played</option>
                  <option value="likelihood">Sort by Likelihood</option>
                  <option value="timesPlayed">Sort by Times Played</option>
                  <option value="alpha">Sort by Aâ€“Z</option>
                </select>
                {filteredSongs.map(song=>{const st=songStatus[song];if(!st)return null;
                  return(
                    <div key={song} style={{...row(),borderLeft:`3px solid ${st.available?'var(--avail)':st.showsSince===0?'var(--played)':'var(--rest)'}`}} onClick={()=>showHistory(song)}>
                      <span style={{fontSize:'.95rem',fontWeight:600,flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{song}</span>
                      <div style={{display:'flex',gap:'.5rem',alignItems:'center',flexShrink:0}}>
                        {st.timesPlayed>0&&<span style={{fontSize:'.72rem',color:'var(--t3)'}}>{st.timesPlayed}Ã—</span>}
                        <span style={chip(st.available?'var(--avail)':st.showsSince===0?'var(--played)':'var(--rest)')}>
                          {st.available?(st.showsSince===Infinity?'Never':'Avail'):st.lastPlayed==='Tonight'?'Tonight':st.showsSince===0?'Latest':`${st.showsSince} ago`}
                        </span>
                      </div>
                    </div>
                  );
                })}
            </div>

            {/* â•â•â• SHOWS â•â•â• */}
            <div style={{display:tab==='shows'&&loadState==='ok'?'block':'none',padding:'1rem 1rem 0'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',paddingTop:'.5rem'}}>
                  <h2 style={sTitle}>Show History</h2>
                  <span style={{fontSize:'.85rem',color:'var(--t3)'}}>{setlists.length} shows</span>
                </div>
                {/* Add */}
                <div style={{padding:'1rem',borderRadius:12,marginBottom:'1.15rem',background:'var(--bg3)',border:'1px solid var(--bdr)'}}>
                  <div style={{fontSize:'.78rem',color:'var(--t2)',marginBottom:'.5rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'.05em'}}>Add Setlist</div>
                  <textarea placeholder={"Add any setlist that isn't already listed!\n11/23/25 Fox Theater - Boulder, CO\nChilly Water, Pigeons, Space Wrangler..."} value={newSongs} onChange={e=>setNewSongs(e.target.value)} style={{...input,minHeight:100,resize:'vertical'}}/>
                  <div style={{display:'flex',gap:'.5rem',marginTop:'.5rem'}}>
                    <input type="date" value={newDate} onChange={e=>setNewDate(e.target.value)} style={{...input,flex:1}}/>
                    <button onClick={addSetlist} style={{padding:'0 1.5rem',borderRadius:10,border:'none',background:'linear-gradient(135deg,var(--red),var(--orange))',color:'#fff',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',letterSpacing:'.06em',cursor:'pointer',whiteSpace:'nowrap'}}>Add</button>
                  </div>
                </div>
                {/* List */}
                {[...setlists].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(sl=>{
                  const acc=showAccuracy[sl.id];const pct=acc?parseInt(acc.predictionAccuracy):null;
                  const ac=pct>=50?'rgb(34,197,94)':pct>=20?'rgb(234,179,8)':'rgb(239,68,68)';
                  return(
                    <div key={sl.id} style={{padding:'.85rem 1rem',borderRadius:10,marginBottom:'.5rem',background:'var(--bg3)',border:'1px solid var(--bdr)'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.3rem'}}>
                        <div>
                          <span style={{fontWeight:700,color:'var(--orange)',fontSize:'.93rem'}}>{sl.date}</span>
                          {sl.city&&<span style={{color:'var(--t3)',fontSize:'.83rem',marginLeft:'.5rem'}}>ğŸ“ {sl.city}</span>}
                        </div>
                        {acc&&<span onClick={()=>setDetailSheet({date:sl.date,city:sl.city||'',predictions:acc.predictions,actualSongs:acc.actualSongs,matchedSongs:acc.matchedSongs,matches:acc.matches,accuracy:acc.predictionAccuracy,runInfo:acc.runShows,excludedSongs:acc.songsPlayedInRun})} style={{...chip(ac),cursor:'pointer'}}>{acc.matches}/10</span>}
                      </div>
                      <div style={{fontSize:'.8rem',color:'var(--t2)',lineHeight:1.5}}>{sl.songs.join(', ')}</div>
                      <div style={{display:'flex',justifyContent:'flex-end',gap:'.5rem',marginTop:'.5rem',paddingTop:'.5rem',borderTop:'1px solid var(--bdr)'}}>
                        <button onClick={()=>setEditingSetlist({...sl,editDate:sl.date,editCity:sl.city||'',editSongs:sl.songs.join('\n')})} style={{background:'none',border:'1px solid var(--bdr)',borderRadius:6,color:'var(--t2)',cursor:'pointer',fontSize:'.78rem',padding:'.4rem .85rem',fontFamily:"'Crimson Pro',serif",minHeight:36}}>âœ Edit</button>
                        <button onClick={()=>delSetlist(sl.id)} style={{background:'none',border:'1px solid rgba(248,113,113,.25)',borderRadius:6,color:'var(--played)',cursor:'pointer',fontSize:'.78rem',padding:'.4rem .85rem',fontFamily:"'Crimson Pro',serif",minHeight:36}}>âœ• Delete</button>
                      </div>
                    </div>
                  );
                })}
            </div>

            {/* â•â•â• SETTINGS â•â•â• */}
            <div style={{display:tab==='settings'&&loadState==='ok'?'block':'none',padding:'1rem 1rem 0'}}>
                <h2 style={{...sTitle,paddingTop:'.5rem'}}>Settings</h2>
                <div style={{fontSize:'.78rem',color:'var(--t2)',marginBottom:'.7rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'.05em'}}>Theme Song Lists</div>
                {Object.entries({valentine:{e:'ğŸ’œ',l:"Valentine's Day",c:'#a855f7',d:'Feb 10-18'},july4th:{e:'ğŸ†',l:'July 4th',c:'#ef4444',d:'Jun 30-Jul 8'},newyear:{e:'ğŸ‰',l:"New Year's",c:'#eab308',d:'Dec 28-Jan 5'},cityReferences:{e:'ğŸ“',l:'City References',c:'var(--orange)',d:'Songâ†’City'},stateReferences:{e:'ğŸ—ºï¸',l:'State References',c:'#3b82f6',d:'Songâ†’State'},sequentialPairs:{e:'ğŸ”—',l:'Sequential Pairs',c:'var(--purple)',d:'Song Aâ†”B'}}).map(([k,info])=>(
                  <div key={k} onClick={()=>startThemeEdit(k,info.l)} style={{...row(),border:`1px solid ${info.c}33`,cursor:'pointer'}}>
                    <div style={{display:'flex',alignItems:'center',gap:'.6rem'}}>
                      <span style={{fontSize:'1.2rem'}}>{info.e}</span>
                      <div><div style={{fontWeight:600,fontSize:'.93rem'}}>{info.l}</div><div style={{fontSize:'.73rem',color:'var(--t3)'}}>{info.d} â€¢ {(themeSongs[k]||[]).length} items</div></div>
                    </div>
                    <span style={{color:'var(--t3)',fontSize:'1.2rem'}}>â€º</span>
                  </div>
                ))}
                <div style={{fontSize:'.78rem',color:'var(--t2)',marginBottom:'.7rem',marginTop:'1.5rem',fontWeight:600,textTransform:'uppercase',letterSpacing:'.05em'}}>Data</div>
                <button onClick={()=>{const d={exportDate:new Date().toISOString(),totalShows:setlists.length,setlists:[...setlists].sort((a,b)=>new Date(a.date)-new Date(b.date)).map(s=>({id:s.id,date:s.date,city:s.city||'',venue:s.venue||'',songs:s.songs})),themeSongs};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`panic-data-${new Date().toISOString().split('T')[0]}.json`;a.click()}} style={{...input,textAlign:'center',cursor:'pointer',color:'var(--purple)',fontWeight:600,marginBottom:'.5rem',border:'1px solid rgba(168,85,247,.2)'}}>ğŸ“¤ Export Data</button>
                <button onClick={()=>{if(confirm('Fix duplicate songs?')){const f=setlists.map(sl=>({...sl,songs:[...new Set(sl.songs)]}));const r=setlists.reduce((s,sl)=>s+sl.songs.length,0)-f.reduce((s,sl)=>s+sl.songs.length,0);setSetlists(f);alert(`Removed ${r} duplicates.`)}}} style={{...input,textAlign:'center',cursor:'pointer',color:'var(--green)',fontWeight:600,marginBottom:'.5rem',border:'1px solid rgba(74,222,128,.2)'}}>ğŸ”§ Fix Duplicate Songs</button>
                <button onClick={()=>window.location.reload()} style={{...input,textAlign:'center',cursor:'pointer',color:'var(--t2)',fontWeight:600,marginBottom:'1.5rem'}}>â˜ï¸ Reload from GitHub</button>
                <div style={{textAlign:'center'}}><button onClick={()=>{if(confirm('âš ï¸ Delete ALL data permanently?')){setSetlists([]);setLiveSets({set1:[],set2:[],encore:[]});setLiveCurrentSet('set1');setCustomSongs([]);localStorage.clear();alert('Reset.')}}} style={{background:'none',border:'none',color:'var(--played)',fontSize:'.85rem',cursor:'pointer',padding:'.5rem',textDecoration:'underline'}}>Reset All Data</button></div>
            </div>
          </div>

          {/* â•â•â• BOTTOM TAB BAR (mobile) â•â•â• */}
          <nav className="bottom-nav" style={{position:'fixed',bottom:0,left:0,right:0,height:'calc(var(--tab-h) + var(--safe-b))',paddingBottom:'var(--safe-b)',background:'rgba(14,14,14,.95)',backdropFilter:'blur(20px)',WebkitBackdropFilter:'blur(20px)',borderTop:'1px solid #222',display:'flex',justifyContent:'space-around',alignItems:'flex-start',zIndex:800,paddingTop:6}}>
            {tabs.map(t=>(
              <button key={t.id} onClick={()=>switchTab(t.id)} style={tabBtn(tab===t.id)}>
                <span style={{fontSize:'1.5rem',lineHeight:1}}>{t.ic}</span>
                <span>{t.l}</span>
                {t.id==='live'&&allLiveSongs.length>0&&<span style={{position:'absolute',top:0,right:2,width:8,height:8,borderRadius:'50%',background:'var(--green)',boxShadow:'0 0 6px var(--green)'}}/>}
              </button>
            ))}
          </nav>

          {/* â•â•â• SHEETS â•â•â• */}

          {/* Unmatched Songs */}
          <Sheet open={unmatchedSongs.length>0} onClose={()=>setUnmatchedSongs([])} title="âš ï¸ Unmatched Songs" titleColor="var(--orange)">
            <p style={{marginBottom:'.75rem',color:'var(--t2)',fontSize:'.9rem'}}>These songs weren't found in the database:</p>
            <div style={{background:'var(--bg)',borderRadius:8,padding:'.5rem',marginBottom:'1rem'}}>
              {unmatchedSongs.map((s,i)=><div key={i} style={{padding:'.5rem',borderBottom:i<unmatchedSongs.length-1?'1px solid var(--bdr)':'none'}}>â€¢ {s}</div>)}
            </div>
            <button onClick={addUnmatchedAndContinue} style={{width:'100%',padding:'.85rem',borderRadius:10,border:'none',background:'linear-gradient(135deg,var(--red),var(--orange))',color:'#fff',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',cursor:'pointer',marginBottom:'.5rem'}}>Add to Database</button>
            <button onClick={skipUnmatched} style={{width:'100%',padding:'.85rem',borderRadius:10,background:'var(--bg3)',border:'1px solid var(--bdr)',color:'var(--t2)',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',cursor:'pointer'}}>Skip These</button>
          </Sheet>

          {/* Edit Setlist */}
          <Sheet open={!!editingSetlist} onClose={()=>setEditingSetlist(null)} title="âœ Edit Setlist" titleColor="var(--orange)">
            {editingSetlist&&(<>
              <div style={{display:'flex',gap:'.5rem',marginBottom:'.75rem'}}>
                <input type="date" value={editingSetlist.editDate} onChange={e=>setEditingSetlist({...editingSetlist,editDate:e.target.value})} style={{...input,flex:1}}/>
                <input type="text" placeholder="City, ST" value={editingSetlist.editCity} onChange={e=>setEditingSetlist({...editingSetlist,editCity:e.target.value})} style={{...input,flex:1}}/>
              </div>
              <div style={{fontSize:'.73rem',color:'var(--t3)',marginBottom:'.35rem'}}>One song per line, or comma-separated</div>
              <textarea value={editingSetlist.editSongs} onChange={e=>setEditingSetlist({...editingSetlist,editSongs:e.target.value})} style={{...input,minHeight:250,resize:'vertical',lineHeight:1.6,fontSize:'.9rem'}}/>
              <div style={{fontSize:'.73rem',color:'var(--t3)',marginTop:'.35rem',marginBottom:'1rem'}}>{editingSetlist.editSongs.split(/[\n,]/).filter(s=>s.trim()).length} songs</div>
              <div style={{display:'flex',gap:'.5rem',position:'sticky',bottom:0,background:'var(--bg2)',paddingTop:'.75rem',paddingBottom:'.5rem'}}>
                <button onClick={saveEditSetlist} style={{flex:1,padding:'.85rem',borderRadius:10,border:'none',background:'linear-gradient(135deg,var(--red),var(--orange))',color:'#fff',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',letterSpacing:'.06em',cursor:'pointer'}}>Save Changes</button>
                <button onClick={()=>setEditingSetlist(null)} style={{flex:1,padding:'.85rem',borderRadius:10,background:'var(--bg3)',border:'1px solid var(--bdr)',color:'var(--t2)',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',cursor:'pointer'}}>Cancel</button>
              </div>
            </>)}
          </Sheet>

          {/* Song History */}
          <Sheet open={!!songSheet} onClose={()=>setSongSheet(null)} title={songSheet?.song||''} titleColor="var(--yellow)" level={2}>
            {songSheet&&(<>
              {(()=>{const cr=(themeSongs['cityReferences']||[]).filter(r=>r.split(':')[0].trim()===songSheet.song).map(r=>r.split(':')[1].trim());
                const sr=(themeSongs['stateReferences']||[]).filter(r=>r.split(':')[0].trim()===songSheet.song).map(r=>r.split(':')[1].trim());
                if(!cr.length&&!sr.length)return null;
                return(<div style={{padding:'.7rem',background:'rgba(255,140,66,.1)',border:'1px solid var(--orange)',borderRadius:8,marginBottom:'1rem'}}>
                  <div style={{fontSize:'.68rem',color:'var(--orange)',fontWeight:700,textTransform:'uppercase',letterSpacing:'.05em',marginBottom:'.2rem'}}>ğŸ“ Location Bonus (+30 pts)</div>
                  {cr.length>0&&<div style={{fontSize:'.85rem'}}>Cities: {cr.join(', ')}</div>}
                  {sr.length>0&&<div style={{fontSize:'.85rem'}}>States: {sr.join(', ')}</div>}
                </div>)})()}
              <div style={{fontSize:'.9rem',color:'var(--t2)',marginBottom:'1rem'}}>
                Played {songSheet.dates.length} time{songSheet.dates.length!==1?'s':''}
                {songStatus[songSheet.song]&&<span> â€¢ {songStatus[songSheet.song].available?'Available':`${songStatus[songSheet.song].showsSince} shows ago`}</span>}
              </div>
              {songSheet.dates.length===0?<div style={{color:'var(--t3)',textAlign:'center',padding:'1.5rem'}}>Never played</div>:
                songSheet.dates.map((s,i)=>(
                  <div key={i} style={{padding:'.6rem 0',borderBottom:i<songSheet.dates.length-1?'1px solid var(--bdr)':'none',display:'flex',justifyContent:'space-between'}}>
                    <span style={{fontWeight:600}}>{fmtDate(s.date)}</span>
                    {s.city&&<span style={{color:'var(--t3)',fontSize:'.85rem'}}>ğŸ“ {s.city}</span>}
                  </div>
                ))}
              {tab==='live'&&!allLiveSongs.includes(songSheet.song)&&(
                <button onClick={()=>{addToLive(songSheet.song);setSongSheet(null)}} style={{width:'100%',padding:'.85rem',marginTop:'1rem',borderRadius:10,border:'none',background:'var(--green)',color:'#000',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',cursor:'pointer',fontWeight:700}}>Add to Live Setlist</button>
              )}
            </>)}
          </Sheet>

          {/* Prediction Detail */}
          <Sheet open={!!detailSheet} onClose={()=>setDetailSheet(null)} title={detailSheet?`ğŸ“Š ${detailSheet.date}`:''} titleColor="var(--purple)" level={2}>
            {detailSheet&&(<>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
                <span style={{color:'var(--t2)',fontSize:'.9rem'}}>ğŸ“ {detailSheet.city}</span>
                <span style={{...chip(parseInt(detailSheet.accuracy)>=50?'rgb(34,197,94)':parseInt(detailSheet.accuracy)>=20?'rgb(234,179,8)':'rgb(239,68,68)'),fontSize:'.85rem',padding:'4px 10px'}}>{detailSheet.matches}/10 ({detailSheet.accuracy}%)</span>
              </div>
              {detailSheet.runInfo?.length>0&&(
                <div style={{padding:'.5rem .7rem',background:'rgba(255,140,66,.1)',border:'1px solid var(--orange)',borderRadius:8,marginBottom:'1rem',fontSize:'.78rem',color:'var(--t2)'}}>
                  <span style={{color:'var(--orange)',fontWeight:600}}>ğŸ”— Multi-Night:</span> {detailSheet.runInfo.map(s=>s.date).join(', ')}
                  {detailSheet.excludedSongs?.length>0&&<span style={{marginLeft:'auto',color:'var(--t3)'}}> â€¢ {detailSheet.excludedSongs.length} excluded</span>}
                </div>
              )}
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.75rem'}}>
                <div>
                  <div style={{fontSize:'.78rem',fontWeight:700,color:'var(--purple)',marginBottom:'.4rem',textTransform:'uppercase',letterSpacing:'.05em'}}>Predictions</div>
                  {detailSheet.predictions.map((s,i)=>{const hit=detailSheet.matchedSongs.includes(s);return(
                    <div key={i} style={{padding:'.35rem .5rem',marginBottom:2,background:hit?'rgba(34,197,94,.2)':'transparent',border:hit?'1px solid rgb(34,197,94)':'1px solid transparent',borderRadius:4,fontSize:'.82rem',display:'flex',alignItems:'center',gap:'.4rem'}}>
                      <span style={{color:'var(--t3)',fontSize:'.72rem',minWidth:'1.1rem'}}>{i+1}.</span>
                      <span style={{color:hit?'rgb(34,197,94)':'var(--t1)',fontWeight:hit?600:'normal',flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{s}</span>
                      {hit&&<span style={{color:'rgb(34,197,94)',fontSize:'.82rem'}}>âœ“</span>}
                    </div>)})}
                </div>
                <div>
                  <div style={{fontSize:'.78rem',fontWeight:700,color:'var(--orange)',marginBottom:'.4rem',textTransform:'uppercase',letterSpacing:'.05em'}}>Actual ({detailSheet.actualSongs.length})</div>
                  <div style={{maxHeight:350,overflow:'auto'}}>
                    {detailSheet.actualSongs.map((s,i)=>{const hit=detailSheet.matchedSongs.includes(s);return(
                      <div key={i} style={{padding:'.35rem .5rem',marginBottom:2,background:hit?'rgba(34,197,94,.2)':'transparent',border:hit?'1px solid rgb(34,197,94)':'1px solid transparent',borderRadius:4,fontSize:'.82rem',display:'flex',alignItems:'center',gap:'.4rem'}}>
                        <span style={{color:hit?'rgb(34,197,94)':'var(--t1)',fontWeight:hit?600:'normal',flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{s}</span>
                        {hit&&<span style={{color:'rgb(34,197,94)',fontSize:'.82rem'}}>âœ“</span>}
                      </div>)})}
                  </div>
                </div>
              </div>
            </>)}
          </Sheet>

          {/* All Songs */}
          <Sheet open={allSongsSheet} onClose={()=>{setAllSongsSheet(false);setSearchTerm('')}} title="All Songs" titleColor="var(--t2)">
            <div style={{position:'sticky',top:'-1rem',background:'var(--bg2)',paddingTop:'0',paddingBottom:'.75rem',zIndex:10}}>
              <input type="text" placeholder="ğŸ” Search..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} style={{...input,marginBottom:'.5rem'}}/>
              <select value={sortBy} onChange={e=>setSortBy(e.target.value)} style={{...input,fontSize:'.85rem',padding:'.6rem .8rem'}}>
                <option value="likelihood">Sort by Likelihood</option>
                <option value="showsSince">Sort by Shows Since Played</option>
                <option value="timesPlayed">Sort by Times Played</option>
                <option value="alpha">Sort by Aâ€“Z</option>
              </select>
            </div>
            {filteredSongs.map(song=>{const st=songStatus[song];if(!st)return null;
              return(
                <div key={song} style={{...row(),borderLeft:`3px solid ${st.available?'var(--avail)':st.showsSince===0?'var(--played)':'var(--rest)'}`}} onClick={()=>showHistory(song)}>
                  <span style={{fontSize:'.95rem',fontWeight:600,flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{song}</span>
                  <div style={{display:'flex',gap:'.5rem',alignItems:'center',flexShrink:0}}>
                    {st.timesPlayed>0&&<span style={{fontSize:'.72rem',color:'var(--t3)'}}>{st.timesPlayed}Ã—</span>}
                    <span style={chip(st.available?'var(--avail)':st.showsSince===0?'var(--played)':'var(--rest)')}>
                      {st.available?(st.showsSince===Infinity?'Never':'Avail'):st.lastPlayed==='Tonight'?'Tonight':st.showsSince===0?'Latest':`${st.showsSince} ago`}
                    </span>
                  </div>
                </div>
              );
            })}
          </Sheet>

          {/* Theme Editor */}
          <Sheet open={themeSheet} onClose={()=>{setThemeSheet(false);setEditingTheme(null)}} title={editingTheme?`Edit ${editingTheme.label}`:''} titleColor="var(--purple)">
            {editingTheme&&(<>
              <div style={{position:'sticky',top:'-1rem',background:'var(--bg2)',paddingTop:0,paddingBottom:'.75rem',zIndex:10}}>
                <input type="text" placeholder="ğŸ” Search songs to add..." value={themeSearchTerm} onChange={e=>setThemeSearchTerm(e.target.value)} style={input}/>
                {themeSearchTerm&&(
                  <div style={{background:'var(--bg)',borderRadius:8,marginTop:4,maxHeight:200,overflow:'auto'}}>
                    {ALL_WITH.filter(s=>s.toLowerCase().includes(themeSearchTerm.toLowerCase())).slice(0,15).map(s=>(
                      <div key={s} onClick={()=>{addToTheme(s);setThemeSearchTerm('')}} style={{padding:'.6rem .8rem',borderBottom:'1px solid var(--bdr)',cursor:'pointer',fontSize:'.9rem'}}>
                        {s}{editingTheme.songs.includes(s)&&<span style={{marginLeft:'.5rem',color:'var(--green)'}}>âœ“</span>}
                      </div>
                    ))}
                  </div>
                )}
              </div>
              <div style={{fontSize:'.78rem',fontWeight:600,color:'var(--t2)',marginBottom:'.5rem'}}>{editingTheme.songs.length} items</div>
              {editingTheme.songs.map(s=>(
                <div key={s} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'.55rem 0',borderBottom:'1px solid var(--bdr)'}}>
                  <span style={{fontSize:'.9rem',flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{s}</span>
                  <button onClick={()=>removeFromTheme(s)} style={{background:'rgba(239,68,68,.15)',border:'1px solid rgb(239,68,68)',color:'rgb(239,68,68)',padding:'2px 8px',borderRadius:4,cursor:'pointer',fontSize:'.72rem',whiteSpace:'nowrap',flexShrink:0}}>Remove</button>
                </div>
              ))}
              <div style={{display:'flex',gap:'.5rem',marginTop:'1.25rem',position:'sticky',bottom:0,background:'var(--bg2)',paddingTop:'.75rem',paddingBottom:'.5rem'}}>
                <button onClick={saveTheme} style={{flex:1,padding:'.85rem',borderRadius:10,border:'none',background:'linear-gradient(135deg,var(--red),var(--orange))',color:'#fff',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',cursor:'pointer'}}>Save</button>
                <button onClick={()=>{setEditingTheme(null);setThemeSheet(false)}} style={{flex:1,padding:'.85rem',borderRadius:10,background:'var(--bg3)',border:'1px solid var(--bdr)',color:'var(--t2)',fontFamily:"'Bebas Neue',sans-serif",fontSize:'1rem',cursor:'pointer'}}>Cancel</button>
              </div>
            </>)}
          </Sheet>

        </div>
      );
    }
    ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
</body>
</html>
